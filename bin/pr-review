#!/bin/bash

# Simple script to show PR diff with comments inline
# Usage: bin/pr-review <pr_number>

set -e

PR_NUM="$1"
if [ -z "$PR_NUM" ]; then
    echo "Usage: $0 <pr_number>"
    exit 1
fi

# Get the basic PR info
echo "=== Pull Request #$PR_NUM ==="
bin/tea-pulls "$PR_NUM" --fields index,title,state,author,head,body

echo ""
echo "=== Comments ==="
bin/tea-pulls "$PR_NUM" --comments

echo ""
echo "=== Diff ==="
# Try to get the diff using git if we're in the right branch
if git rev-parse --verify "origin/feature/$PR_NUM-*" >/dev/null 2>&1; then
    # Find the feature branch
    BRANCH=$(git branch -r | grep "origin/feature/$PR_NUM-" | head -1 | sed 's/.*origin\///')
    if [ -n "$BRANCH" ]; then
        echo "Showing diff for branch: $BRANCH"
        git diff "origin/main..origin/$BRANCH"
    else
        echo "Could not find feature branch for PR #$PR_NUM"
    fi
elif git rev-parse --verify "feature/$PR_NUM-*" >/dev/null 2>&1; then
    # Local feature branch
    BRANCH=$(git branch | grep "feature/$PR_NUM-" | head -1 | sed 's/^[* ] *//')
    if [ -n "$BRANCH" ]; then
        echo "Showing diff for local branch: $BRANCH"  
        git diff "main..$BRANCH"
    fi
else
    echo "No feature branch found for PR #$PR_NUM"
    echo "Try: git fetch origin"
fi