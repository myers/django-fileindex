#!/bin/bash

# Script to fetch PR reviews with comments using Gitea API
# Usage: bin/pr-reviews <pr_number>

set -e

PR_NUM="$1"
if [ -z "$PR_NUM" ]; then
    echo "Usage: $0 <pr_number>"
    echo "Fetches pull request reviews and comments from Gitea API"
    exit 1
fi

# Get the repo info from git remote
REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
if [ -z "$REMOTE_URL" ]; then
    echo "Error: No git remote 'origin' found"
    exit 1
fi

# Extract owner and repo from git remote URL
# Handle both SSH and HTTPS formats
if [[ $REMOTE_URL == *"@"* ]]; then
    # SSH format: ssh://git@host:port/owner/repo.git or git@host:owner/repo.git
    REPO_PATH=$(echo "$REMOTE_URL" | sed -E 's|.*[@/]([^:/]+/[^:/]+)\.git.*|\1|' | sed 's|.*:||')
else
    # HTTPS format: https://host/owner/repo.git
    REPO_PATH=$(echo "$REMOTE_URL" | sed -E 's|.*/([^/]+/[^/]+)\.git.*|\1|')
fi

if [ -z "$REPO_PATH" ] || [[ ! "$REPO_PATH" == *"/"* ]]; then
    echo "Error: Could not parse repository path from remote: $REMOTE_URL"
    echo "Extracted: $REPO_PATH"
    exit 1
fi

OWNER=$(echo "$REPO_PATH" | cut -d'/' -f1)
REPO=$(echo "$REPO_PATH" | cut -d'/' -f2)

# Extract the base URL from remote
if [[ $REMOTE_URL == ssh://* ]]; then
    # ssh://git@host:port/path format
    BASE_URL=$(echo "$REMOTE_URL" | sed -E 's|ssh://[^@]+@([^:/]+):?[0-9]*.*|https://\1|')
elif [[ $REMOTE_URL == *"@"* ]]; then
    # git@host:path format  
    BASE_URL=$(echo "$REMOTE_URL" | sed -E 's|[^@]+@([^:]+):.*|https://\1|')
else
    # https format
    BASE_URL=$(echo "$REMOTE_URL" | sed -E 's|(https?://[^/]+).*|\1|')
fi

echo "=== Pull Request #$PR_NUM Reviews ==="
echo "Repository: $OWNER/$REPO"
echo "Base URL: $BASE_URL"
echo ""

# Fetch reviews
REVIEWS_URL="$BASE_URL/api/v1/repos/$OWNER/$REPO/pulls/$PR_NUM/reviews"
echo "Fetching reviews from: $REVIEWS_URL"
echo ""

# Use curl to fetch reviews
REVIEWS=$(curl -s "$REVIEWS_URL" 2>/dev/null)

if [ $? -ne 0 ] || [ -z "$REVIEWS" ]; then
    echo "Error: Could not fetch reviews from API"
    echo "URL: $REVIEWS_URL"
    exit 1
fi

# Check if it's valid JSON and not an error
if echo "$REVIEWS" | jq empty 2>/dev/null; then
    REVIEW_COUNT=$(echo "$REVIEWS" | jq length)
    
    if [ "$REVIEW_COUNT" -eq 0 ]; then
        echo "No reviews found for PR #$PR_NUM"
        exit 0
    fi
    
    echo "Found $REVIEW_COUNT review(s)"
    echo ""
    
    # Process each review
    for i in $(seq 0 $((REVIEW_COUNT - 1))); do
        REVIEW=$(echo "$REVIEWS" | jq ".[$i]")
        REVIEW_ID=$(echo "$REVIEW" | jq -r ".id")
        REVIEW_STATE=$(echo "$REVIEW" | jq -r ".state")
        REVIEWER=$(echo "$REVIEW" | jq -r ".user.login")
        REVIEW_BODY=$(echo "$REVIEW" | jq -r ".body // empty")
        SUBMITTED_AT=$(echo "$REVIEW" | jq -r ".submitted_at")
        
        echo "--- Review #$REVIEW_ID ---"
        echo "Reviewer: @$REVIEWER"
        echo "State: $REVIEW_STATE"
        echo "Submitted: $SUBMITTED_AT"
        
        if [ -n "$REVIEW_BODY" ] && [ "$REVIEW_BODY" != "null" ]; then
            echo "Review comment:"
            echo "$REVIEW_BODY"
        fi
        
        # Fetch review comments
        COMMENTS_URL="$BASE_URL/api/v1/repos/$OWNER/$REPO/pulls/$PR_NUM/reviews/$REVIEW_ID/comments"
        COMMENTS=$(curl -s "$COMMENTS_URL" 2>/dev/null)
        
        if echo "$COMMENTS" | jq empty 2>/dev/null; then
            COMMENT_COUNT=$(echo "$COMMENTS" | jq length)
            
            if [ "$COMMENT_COUNT" -gt 0 ]; then
                echo ""
                echo "Code comments ($COMMENT_COUNT):"
                
                # Process each comment
                for j in $(seq 0 $((COMMENT_COUNT - 1))); do
                    COMMENT=$(echo "$COMMENTS" | jq ".[$j]")
                    COMMENT_PATH=$(echo "$COMMENT" | jq -r ".path")
                    COMMENT_LINE=$(echo "$COMMENT" | jq -r ".line // .old_line // empty")
                    COMMENT_BODY=$(echo "$COMMENT" | jq -r ".body")
                    
                    echo "  ðŸ“„ $COMMENT_PATH"
                    if [ -n "$COMMENT_LINE" ] && [ "$COMMENT_LINE" != "null" ]; then
                        echo "     Line $COMMENT_LINE:"
                    fi
                    echo "     $COMMENT_BODY"
                    echo ""
                done
            fi
        fi
        
        echo ""
    done
else
    echo "Error: Invalid response from API"
    echo "Response: $REVIEWS"
fi